<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Employee Handbook with Signature Fields</title>
  <style>
    #textContainer {
      width: 80%;
      margin: 20px auto;
      padding: 10px;
      border: 1px solid #ccc;
      line-height: 1.8;
      white-space: pre-wrap;
      font-family: Arial, sans-serif;
    }
    .signature-field {
      display: inline-block;
      margin-left: 10px;
      padding: 5px;
      font-size: 14px;
      border: 2px solid red; /* Initial red border */
      width: 200px;
    }
    .signature-field.valid {
      border-color: green; /* Green border when valid */
    }
    .signature-field.invalid {
      border-color: red; /* Red border when invalid */
    }
  </style>
</head>
<body>
  <h1>Employee Handbook with Signature Fields</h1>

  <!-- Container to display the text content -->
  <div id="textContainer"></div>

  <!-- Button to submit signatures and convert to PDF -->
  <button id="submitSignaturesBtn">Submit Signatures & Convert to PDF</button>

  <script>
    const textUrl = 'https://theeuropean417.github.io/TheEuropeanEmployee/Employee-Handbook-Text.txt';
    const textContainer = document.getElementById('textContainer');

    // Function to fetch and display text content from the plain text file
    async function loadTextFile() {
      try {
        const response = await fetch(textUrl);
        const textContent = await response.text();

        // Replace "Acknowledgment:" with "Acknowledgment:" and a signature input field
        const updatedText = textContent.replace(/Acknowledgment:/g, 'Acknowledgment:<input type="text" placeholder="Sign here" class="signature-field">');

        // Set the updated text with signature fields into the container
        textContainer.innerHTML = `<p>${updatedText}</p>`;

        // Attach event listeners to signature fields after loading the text
        attachSignatureValidation();
      } catch (error) {
        console.error('Error loading text file:', error);
      }
    }

    // Function to attach event listeners to signature fields
    function attachSignatureValidation() {
      const signatureFields = document.querySelectorAll('.signature-field');
      const params = new URLSearchParams(window.location.search);
      const employeeName = params.get('name').toLowerCase(); // Get the employee name and make it lowercase

      signatureFields.forEach(field => {
        field.addEventListener('input', function() {
          const fieldValue = field.value.trim().toLowerCase(); // Get input and convert to lowercase
          
          if (fieldValue === employeeName) {
            field.classList.add('valid');
            field.classList.remove('invalid');
          } else {
            field.classList.add('invalid');
            field.classList.remove('valid');
          }
        });
      });
    }

    window.onload = function() {
      // Extract the name parameter from the URL
      const params = new URLSearchParams(window.location.search);
      const employeeName = params.get('name');

      // If the name exists, append it to the title
      if (employeeName) {
        document.title = `Employee Handbook with Signature Fields - ${employeeName}`;
        document.querySelector('h1').innerText = `Employee Handbook for ${employeeName}`;
      }

      // Load the text file content
      loadTextFile();
    };

    // Function to convert HTML back to PDF using pdf-lib
    async function convertHtmlToPDF() {
      const { PDFDocument } = PDFLib;

      // Create a new PDF document
      const pdfDoc = await PDFDocument.create();
      const page = pdfDoc.addPage([600, 800]);
      const { width, height } = page.getSize();

      // Get signature inputs from the HTML
      const signatureFields = document.querySelectorAll('.signature-field');
      const signatures = [];
      signatureFields.forEach((field, index) => {
        const value = field.value.trim();
        if (value === '') {
          alert('Please fill out all signature fields.');
          throw new Error('Incomplete signatures');
        }
        signatures.push(value);
      });

      // Add text and signatures to the PDF
      const lines = textContainer.innerText.split('\n');
      let yOffset = height - 50; // Start from top of page
      lines.forEach((line, lineIndex) => {
        // Add the text line to the PDF
        page.drawText(line, { x: 50, y: yOffset, size: 12 });

        // For each signature field, draw the signature on the PDF
        if (line.includes('Acknowledgment:')) {
          const signature = signatures.shift(); // Get the corresponding signature
          page.drawText(signature, { x: 400, y: yOffset, size: 12 });
        }

        yOffset -= 20; // Move to the next line
      });

      // Save the modified PDF
      const pdfBytes = await pdfDoc.save();
      return new Blob([pdfBytes], { type: 'application/pdf' });
    }

    // Function to download the generated PDF
    function downloadPDF(pdfBlob) {
      const url = URL.createObjectURL(pdfBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'signed-employee-handbook.pdf';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Button click event to submit signatures, convert to PDF, and download
    document.getElementById('submitSignaturesBtn').addEventListener('click', async () => {
      try {
        const pdfBlob = await convertHtmlToPDF();
        downloadPDF(pdfBlob);
      } catch (error) {
        console.error('Error during PDF generation:', error.message);
      }
    });
  </script>
</body>
</html>
