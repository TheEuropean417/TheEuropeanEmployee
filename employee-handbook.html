<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF Rendering with Signature Fields</title>
  <!-- pdfjs-dist for rendering PDF files -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
  <!-- pdf-lib for manipulating PDF files -->
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <!-- Google API JS client -->
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    #pdfContainer {
      width: 100%;
      margin: 0 auto;
      position: relative;
    }
    canvas {
      margin-bottom: 20px;
      border: 1px solid #ddd;
    }
    .signature-field {
      position: absolute;
      font-size: 14px;
      padding: 5px;
      border: 1px solid #000;
      width: 200px;
    }
  </style>
</head>
<body>
  <h1>PDF Rendering with Signature Fields</h1>

  <!-- Container to hold rendered PDF pages -->
  <div id="pdfContainer"></div>
  <button id="submitSignaturesBtn">Submit Signatures & Upload PDF</button>

  <script>
    const pdfUrl = 'https://theeuropean417.github.io/TheEuropeanEmployee/handbook-template.pdf';
    const pdfContainer = document.getElementById('pdfContainer');
    const signatures = [];

    // Load and render the PDF on page load
    window.onload = async function() {
      await renderPDF();
    };

    // Function to render the PDF pages and scan for "Acknowledgment:" after rendering
    async function renderPDF() {
      try {
        const loadingTask = pdfjsLib.getDocument(pdfUrl);
        const pdf = await loadingTask.promise;

        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
          const page = await pdf.getPage(pageNum);
          const scale = 1.5;
          const viewport = page.getViewport({ scale });

          const canvas = document.createElement('canvas');
          const context = canvas.getContext('2d');
          canvas.width = viewport.width;
          canvas.height = viewport.height;

          const renderContext = {
            canvasContext: context,
            viewport: viewport,
          };
          await page.render(renderContext).promise;

          // Append the canvas to the container
          pdfContainer.appendChild(canvas);

          // Extract text after rendering the page
          const textContent = await page.getTextContent();

          // Process each text item on the page to find "Acknowledgment:"
          textContent.items.forEach((item) => {
            if (item.str.includes('Acknowledgment:')) {
              const signatureField = document.createElement('input');
              signatureField.type = 'text';
              signatureField.placeholder = 'Enter Signature';
              signatureField.classList.add('signature-field');
              signatures.push({ signatureField, pageNum });

              // Position the signature field based on the coordinates of "Acknowledgment:"
              const x = (item.transform[4] + 150); // X coordinate, adjusted for the position
              const y = (viewport.height - item.transform[5] - 20); // Y coordinate (inverted for canvas)

              // Style and position the signature field
              signatureField.style.left = `${x}px`;
              signatureField.style.top = `${y}px`;
              signatureField.style.width = '200px';

              // Append the signature field to the container
              pdfContainer.appendChild(signatureField);
            }
          });
        }
      } catch (error) {
        console.error('Error rendering PDF:', error.message);
      }
    }

    // Function to capture signatures and convert PDF back to PDF with signatures
    document.getElementById('submitSignaturesBtn').addEventListener('click', async () => {
      // Ensure all signatures are filled out
      for (let i = 0; i < signatures.length; i++) {
        if (!signatures[i].signatureField.value) {
          alert('Please fill out all signature fields.');
          return;
        }
      }

      // Load the PDF with pdf-lib
      const existingPdfBytes = await fetch(pdfUrl).then((res) => res.arrayBuffer());
      const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
      const pages = pdfDoc.getPages();

      // Add typed signatures to the corresponding page and location
      signatures.forEach((signature, index) => {
        const pageIndex = signature.pageNum - 1;  // Convert page number to 0-based index
        const page = pages[pageIndex];
        const signatureText = signature.signatureField.value;

        // Add the signature text near the footer of the page (adjust x, y for positioning)
        page.drawText(signatureText, {
          x: 400,  // Adjust x as needed
          y: 50,   // Adjust y as needed (footer position)
          size: 12,
        });
      });

      // Save the updated PDF
      const pdfBytes = await pdfDoc.save();

      // Convert the updated PDF to a blob
      const blob = new Blob([pdfBytes], { type: 'application/pdf' });

      // Upload the PDF to Google Drive
      uploadFileToDrive(blob);
    });

    // Function to upload the PDF to Google Drive
    function uploadFileToDrive(blob) {
      const metadata = {
        name: 'signed-employee-handbook.pdf',
        mimeType: 'application/pdf',
        parents: ['19aBK3wMPVq9LfDeI0T4NDOQO8fzB38Dl'], // Google Drive folder ID
      };

      const form = new FormData();
      form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
      form.append('file', blob);

      // Load the Google API client and authenticate
      gapi.load('client:auth2', () => {
        gapi.auth2.init({
          apiKey: 'AIzaSyAXHsPZNkfoNFCRflMdnC8-FUmpzZeHFIM',
          clientId: '1092193969062-bu0vdc6317v4in97k9glu2gauq8m0786.apps.googleusercontent.com',
          discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
          scope: 'https://www.googleapis.com/auth/drive.file',
        }).then(() => {
          const authInstance = gapi.auth2.getAuthInstance();
          authInstance.signIn().then(() => {
            const accessToken = authInstance.currentUser.get().getAuthResponse().access_token;

            // Upload file to Google Drive
            fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
              method: 'POST',
              headers: new Headers({
                'Authorization': 'Bearer ' + accessToken,
              }),
              body: form,
            })
            .then((response) => response.json())
            .then((data) => {
              alert('PDF uploaded successfully with ID: ' + data.id);
            })
            .catch((error) => {
              console.error('Error uploading PDF:', error.message);
            });
          });
        });
      });
    }
  </script>
</body>
</html>
